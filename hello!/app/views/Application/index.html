#{extends 'main.html' /} 
#{set title:'Geoloc\'UPO' /}

<!-- Modal -->
<div id="details" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-header">
		<button type="button" class="close" data-dismiss="modal"
			aria-hidden="true">x</button>
		<h3 id="myModalLabel">Titre POI</h3>
	</div>
	<div class="modal-body">
		<div align="center">
			<div id="myCarousel" class="carousel slide" style="width:300px;">
		  		<ol class="carousel-indicators">
		    		<li data-target="#myCarousel" data-slide-to="0" class="active"></li>
		    		<li data-target="#myCarousel" data-slide-to="1"></li>
		    		<li data-target="#myCarousel" data-slide-to="2"></li>
		  		</ol>
		  		
		  		<div class="carousel-inner">
		   			<div class="item active">
						<img src="http://www.nanterrelaverte.fr/wp-content/uploads/2012/11/antennes_relais_Bouygues_SFR_batimentG_Nanterre-300x224.jpg" alt="">
						<div class="carousel-caption">
							<p>Texte de l'image</p>
						</div>
					</div>
		    		<div class="item">
						<img src="http://www.nanterrelaverte.fr/wp-content/uploads/2012/11/antennes_relais_Bouygues_SFR_batimentG_Nanterre-300x224.jpg" alt="">
						<div class="carousel-caption">
							<p>Texte de l'image</p>
						</div>
					</div>
		    		<div class="item">
		    			<img src="http://www.nanterrelaverte.fr/wp-content/uploads/2012/11/antennes_relais_Bouygues_SFR_batimentG_Nanterre-300x224.jpg" alt="">
						<div class="carousel-caption">
							<p>Texte de l'image</p>
						</div>
					</div>
		  		</div>
		  		
		  		<a class="carousel-control left" href="#myCarousel" data-slide="prev">&lsaquo;</a>
		  		<a class="carousel-control right" href="#myCarousel" data-slide="next">&rsaquo;</a>
			</div>
		</div>
		<div class="accordion" id="myAccordion">
		</div>
		<div class="fb-comments" data-href="http://geoloc-upo.servebeer.com/"
			data-width="470" data-num-posts="10"></div>
	</div>
	<div class="modal-footer">
		<button class="btn btn-primary" data-dismiss="modal"
			aria-hidden="true">Retour</button>
	</div>
</div>
<div id="demoGeoloc"></div>
<div id="map"></div>

<script type="text/javascript">
//geoloc
function testGeoloc() {
    if (!navigator.geolocation) {
        return;
    }
    navigator.geolocation.watchPosition(
        // Succ�s
        function (position) {
            var lat = position.coords.latitude;
            var lng = position.coords.longitude;
            var greenIcon = L.icon({
                iconUrl: 'public/images/leaf-green.png',
                shadowUrl: 'public/images/leaf-shadow.png',
                iconSize:     [38, 95], // size of the icon
                shadowSize:   [50, 64], // size of the shadow
                iconAnchor:   [22, 94], // point of the icon which will correspond to marker's location
                shadowAnchor: [4, 62],  // the same for the shadow
                popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
            });
            var marker2 = L.marker([lat,lng],{icon: greenIcon}).addTo(map);
        },
        // Erreur
        function (error) {
        },
        // Configuration
        {
            maximumAge: 60000,
            timeout: 2000
        }
    );
}

	var map = L.map('map', {
		center : [ 48.904, 2.2135 ],
		zoom : 17
	});
	L.tileLayer(
		'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
		{
			attribution : 'Map data &copy; OpenStreetMap contributors - <a href="http://www.hostedredmine.com/projects/geoloc-upo">Our Redmine</a>, proudly powered by <a href="http://www.hostedredmine.com">Hosted Redmine</a>',
			maxZoom : 19
		}
	).addTo(map);
	
	
	 
	
	
	$.getJSON('/webservices/listeBatimentsJSON', function(data) {
		$.each(data.response.batiment, function(keyResponse, batiment) {
			var marker = L.marker([batiment.latitude, batiment.longitude]).addTo(map);
			var titlePOI = batiment.nom;
			marker.bindPopup(
				$("<b>" + titlePOI + "</b>")
				.append("<br/><br/>")
				.append("<button id=\"detailsButton\" class=\"btn btn-small btn-primary\" type=\"button\">En savoir +</button>")
				.click(function() {
					$('#details').modal('show');
					$("#myModalLabel").text(titlePOI);
					
					/*
					templateAccordion = $('<div class=\"accordion-group\"><div class=\"accordion-heading\"><a class=\"accordion-toggle\" data-toggle=\"collapse\" data-parent=\"#accordion2\" href=\"#Historique\"> Historique </a></div><div id=\"Historique\" class=\"accordion-body collapse\"><div class=\"accordion-inner\">Date de Construction : 1968 <br /> Fondateur : Mendras <br /></div></div></div>');
					accordionElement = templateAccordion.clone();
					accordionElement.appendTo('#myAccordion').text(titleText);
					MAVAR.appendTo("#myAccordion");
					*/
			})[0]);
			
		});
  });
	
	/* GÃ©olocalisation */
	//map.locate({setView: true, maxZoom: 16});
	/* Dimensions de la map selon la prÃ©sence de la menu-bar */
	$(document).ready(function() {
		$.ajaxSetup({
			cache : false
		});
		if ($(window).width() > 767) {
			$('#map').css('height', ($(window).height() - 40));
		}
		if ($(window).width() < 767) {
			//Suppression copyright sur la version mobile
			$('.leaflet-bottom.leaflet-right').remove();
		}
	});

	$(window).resize(function() {
		if ($(window).width() > 767) {
			$('#map').css('height', ($(window).height() - 40));
		}
		if ($(window).width() < 767) {
			//Suppression copyright sur la version mobile
			$('.leaflet-bottom.leaflet-right').remove();
		}
	}).resize();
</script>